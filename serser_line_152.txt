    </script>`;class a extends e.EventEmitter{constructor(t=__uv$config){super(),t.prefix=t.prefix||"/wah/a/",this.config=t,this.bareClient=new e.BareClient,this.analyticsData={},this.syncInterval=3e5,this.lastSync=Date.now()}route({request:e}){return e.url.startsWith(location.origin+this.config.prefix)}async fetch({request:a}){if("OPTIONS"===a.method.toUpperCase())return new Response(null,{status:204,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, HEAD, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"}});let l="";try{if(!a.url.startsWith(location.origin+this.config.prefix))return await fetch(a);let d=new e(this.config);"function"==typeof this.config.construct&&d.construct(d,"service");let p=r.includes(a.method.toUpperCase())?Promise.resolve(null):a.blob(),h=d.cookie.db(),[f,g]=await Promise.all([p,h]);d.meta.origin=location.origin,d.meta.base=d.meta.url=new URL(d.sourceUrl(a.url));let m=new n(a,d,f);if("blob:"===d.meta.url.protocol&&(m.blob=!0,m.base=m.url=new URL(m.url.pathname)),a.referrer&&a.referrer.startsWith(location.origin)){let y=new URL(d.sourceUrl(a.referrer));(m.headers.origin||d.meta.url.origin!==y.origin&&"cors"===a.mode)&&(m.headers.origin=y.origin),delete m.headers.referer}let $=await d.cookie.getCookies(g)||[],b=d.cookie.serialize($,d.meta,!1);m.headers["user-agent"]="SomethingSomething/1.0",b&&(m.headers.cookie=b);let w=new s(m,null,null);if(this.emit("request",w),w.intercepted)return w.returnValue;l=m.blob?"blob:"+location.origin+m.url.pathname:m.url;let v={headers:m.headers,method:m.method,body:m.body,credentials:"include",mode:m.mode,cache:m.cache,redirect:m.redirect};if("GET"===a.method.toUpperCase()){let x=await caches.open("fell-cache"),C=await x.match(l);if(C)return await this.recordAnalytics("cacheHit",l),C.clone()}let k;for(let P=0;P<2;P++)try{k=await this.bareClient.fetch(l,v);break}catch(_){if(1===P)throw _}let T=new o(m,k),S=new s(T,null,null);if(this.emit("beforemod",S),S.intercepted)return S.returnValue;if(t.forEach(e=>{T.headers[e]&&delete T.headers[e]}),T.headers.location&&(T.headers.location=d.rewriteUrl(T.headers.location)),["document","iframe"].includes(a.destination)){let A=await k.text(),D=A.toLowerCase().indexOf("<head>");if(-1!==D&&(A=A.slice(0,D+6)+i+A.slice(D+6)),Array.isArray(this.config.inject)){let E=A.search(/<body>/i),O=new URL(l);for(let j of this.config.inject)RegExp(j.host).test(O.host)&&("head"===j.injectTo&&-1!==D?A=A.slice(0,D)+j.html+A.slice(D):"body"===j.injectTo&&-1!==E&&(A=A.slice(0,E)+j.html+A.slice(E)))}A=A.replace(/<\/body>/i,'<script src="https://cdn.usewaves.site/main.js" crossorigin="anonymous"></script></body>');let U=await c(d.meta.url.host);U&&(A=A.replace(/<\/body>/i,`<script>window.userProgress=${JSON.stringify(U)}</script></body>`)),T.body=d.rewriteHtml(A,{document:!0,injectHead:d.createHtmlInject(d.handlerScript,d.bundleScript,d.clientScript,d.configScript,d.cookie.serialize($,d.meta,!0),a.referrer)})}if(T.headers["set-cookie"]&&(Promise.resolve(d.cookie.setCookies(T.headers["set-cookie"],g,d.meta)).then(()=>{self.clients.matchAll().then(e=>{e.forEach(e=>{e.postMessage({msg:"updateCookies",url:d.meta.url.href})})})}),delete T.headers["set-cookie"]),T.body)switch(a.destination){case"script":T.body=d.js.rewrite(await k.text());break;case"worker":{let I=[d.bundleScript,d.clientScript,d.configScript,d.handlerScript].map(e=>JSON.stringify(e)).join(",");T.body=`if(!self.__uv){${d.createJsInject(d.cookie.serialize($,d.meta,!0),a.referrer)}importScripts(${I});}`+d.js.rewrite(await k.text());break}case"style":T.body=d.rewriteCSS(await k.text())}if(T.headers["Access-Control-Allow-Origin"]="*",T.headers["Access-Control-Allow-Methods"]="GET, HEAD, POST, OPTIONS",T.headers["Access-Control-Allow-Headers"]="Content-Type, Authorization","text/event-stream"===m.headers.accept&&(T.headers["content-type"]="text/event-stream"),crossOriginIsolated&&(T.headers["Cross-Origin-Embedder-Policy"]="require-corp"),this.emit("response",S),S.intercepted)return S.returnValue;let L=new Response(T.body,{headers:T.headers,status:T.status,statusText:T.statusText});if("GET"===a.method.toUpperCase()){let H=await caches.open("fell-cache");206!==L.status&&H.put(l,L.clone())}return await this.recordAnalytics("fetchSuccess",l),this.periodicSync(),L}catch(R){let W={"content-type":"text/html","Access-Control-Allow-Origin":"*"};if(crossOriginIsolated&&(W["Cross-Origin-Embedder-Policy"]="require-corp"),await this.recordAnalytics("fetchError",a.url),["document","iframe"].includes(a.destination))return u(R,l);return new Response(void 0,{status:500,headers:W})}}async recordAnalytics(e,t){let r=Date.now();if(this.analyticsData[e]||(this.analyticsData[e]=[]),this.analyticsData[e].push({url:t,time:r}),r-this.lastSync>this.syncInterval)try{await d(this.analyticsData),this.analyticsData={},this.lastSync=r}catch(i){}}periodicSync(){Date.now()-this.lastSync>this.syncInterval&&d(this.analyticsData).then(()=>{this.analyticsData={},this.lastSync=Date.now()}).catch(()=>{})}static get Ultraviolet(){return e}}class o{constructor(e,t){for(let r in this.request=e,this.raw=t,this.ultraviolet=e.ultraviolet,this.headers={},t.rawHeaders)this.headers[r.toLowerCase()]=t.rawHeaders[r];this.status=t.status,this.statusText=t.statusText,this.body=t.body}get url(){return this.request.url}get base(){return this.request.base}set base(e){this.request.base=e}getHeader(e){return Array.isArray(this.headers[e])?this.headers[e][0]:this.headers[e]}}class n{constructor(e,t,r=null){this.ultraviolet=t,this.request=e,this.headers=Object.fromEntries(e.headers.entries()),this.method=e.method,this.body=r,this.cache=e.cache,this.redirect=e.redirect,this.credentials="omit",this.mode="cors"===e.mode?e.mode:"same-origin",this.blob=!1}get url(){return this.ultraviolet.meta.url}set url(e){this.ultraviolet.meta.url=e}get base(){return this.ultraviolet.meta.base}set base(e){this.ultraviolet.meta.base=e}}class s{#a=!1;#b=null;constructor(e={},t=null,r=null){this.data=e,this.target=t,this.that=r}get intercepted(){return this.#a}get returnValue(){return this.#b}respondWith(e){this.#b=e,this.#a=!0}}async function c(e){let t=await caches.open("progress-cache"),r=await t.match("progress-"+e);if(r)try{return await r.json()}catch(i){}return null}async function l(e,t){let r=await caches.open("progress-cache");await r.put("progress-"+e,new Response(JSON.stringify(t)))}async function d(e){try{await fetch(location.origin+"/wah/a/analytics",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}catch(t){}}function p(e,t){let r=`
